<!doctype html>
<html lang="{{ request.locale.iso_code }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="#1d1e26">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <link rel="canonical" href="{{ canonical_url }}">

    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- else -%}
      <link rel="icon" type="image/x-icon" href="{{ 'favicon.ico' | asset_url }}">
    {%- endif -%}

    <title>
      {{ page_title }}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>

    {% if page_description %}
      <meta name="description" content="{{ page_description | escape }}">
    {% endif %}

    {% render 'meta-tags' %}

    {%- comment -%} Required Shopify content_for_header tag {%- endcomment -%}
    {{ content_for_header }}

    {%- comment -%} Clean up problematic preload tags {%- endcomment -%}
    <script>
      // Remove problematic preload tags that cause 404 errors
      document.addEventListener('DOMContentLoaded', function () {
        const preloads = document.querySelectorAll('link[rel="preload"]');
        preloads.forEach(function (preload) {
          const href = preload.getAttribute('href');
          if (
            href &&
            (href.includes('/assets/style-base.css') ||
              href.includes('/assets/core-global.js') ||
              href.includes('/assets/core-init.js'))
          ) {
            preload.remove();
          }
        });
      });

      // Suppress non-critical console warnings
      const originalWarn = console.warn;
      const originalError = console.error;

      console.warn = function (...args) {
        const message = args.join(' ');

        // Suppress specific non-critical warnings
        if (
          message.includes('preloaded with link preload was not used within a few seconds') ||
          message.includes('Ignoring unsupported entryTypes: layout-shift') ||
          message.includes('No valid entryTypes; aborting registration') ||
          message.includes('Expected media feature name but found') ||
          message.includes('Unknown property') ||
          message.includes('Error in parsing value for') ||
          message.includes('Found invalid value for media feature') ||
          message.includes('Ruleset ignored due to bad selector') ||
          message.includes('Unknown pseudo-class or pseudo-element') ||
          message.includes('Declaration dropped') ||
          message.includes('Cookie has been rejected for invalid domain') ||
          message.includes('Content-Security-Policy: Ignoring')
        ) {
          return; // Suppress these warnings
        }

        // Log other warnings normally
        originalWarn.apply(console, args);
      };

      console.error = function (...args) {
        const message = args.join(' ');

        // Suppress specific non-critical errors
        if (
          message.includes('Source map error') ||
          message.includes('installHook.js.map') ||
          (message.includes('404') && message.includes('assets/'))
        ) {
          return; // Suppress these errors
        }

        // Log other errors normally
        originalError.apply(console, args);
      };

      // Handle duplicate custom element registration gracefully
      const originalDefine = window.customElements.define;
      window.customElements.define = function (name, constructor, options) {
        try {
          return originalDefine.call(this, name, constructor, options);
        } catch (error) {
          if (error.message.includes('has already been defined')) {
            console.debug(`Custom element '${name}' already defined, skipping registration`);
            return;
          }
          throw error;
        }
      };
    </script>

    {%- comment -%} Resource hints for performance optimization {%- endcomment -%}
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.shopify.com">
    <link rel="dns-prefetch" href="https://fonts.shopifycdn.com">

    {%- comment -%} Preload critical JavaScript bundles {%- endcomment -%}
    {{ 'core.bundle.js' | asset_url | preload_tag: as: 'script' }}

    {%- liquid
      assign body_font_bold = settings.type_body_font | font_modify: 'weight', 'bold'
      assign body_font_italic = settings.type_body_font | font_modify: 'style', 'italic'
      assign body_font_bold_italic = body_font_bold | font_modify: 'style', 'italic'
    %}

    {%- comment -%} Font preloading for performance {%- endcomment -%}
    {%- unless settings.type_body_font.system? -%}
      {%- assign body_font_url = settings.type_body_font | font_url -%}
      {%- if body_font_url != blank -%}
        {{ body_font_url | preload_tag: as: 'font', type: 'font/woff2' }}
      {%- endif -%}
    {%- endunless -%}
    {%- unless settings.type_heading_font.system? -%}
      {%- assign heading_font_url = settings.type_heading_font | font_url -%}
      {%- if heading_font_url != blank -%}
        {{ heading_font_url | preload_tag: as: 'font', type: 'font/woff2' }}
      {%- endif -%}
    {%- endunless -%}

    {%- comment -%} Load main CSS normally {%- endcomment -%}
    {{ 'style-base.css' | asset_url | stylesheet_tag }}

    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
      if (Shopify.designMode) {
        document.documentElement.classList.add('shopify-design-mode');
      }
    </script>

    {%- comment -%} Load init script immediately to prevent FOUC {%- endcomment -%}
    <script src="{{ 'core-init.js' | asset_url }}" defer="defer"></script>

    {%- comment -%} Define global routes for JavaScript {%- endcomment -%}
    <script>
      window.routes = {
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_update_url: '{{ routes.cart_update_url }}',
        cart_url: '{{ routes.cart_url }}',
        predictive_search_url: '{{ routes.predictive_search_url }}',
        search_url: '{{ routes.search_url }}',
        root_url: '{{ routes.root_url }}',
        account_url: '{{ routes.account_url }}',
        account_login_url: '{{ routes.account_login_url }}',
        account_register_url: '{{ routes.account_register_url }}',
        account_logout_url: '{{ routes.account_logout_url }}',
        account_addresses_url: '{{ routes.account_addresses_url }}',
        account_recover_url: '{{ routes.account_recover_url }}',
        all_products_collection_url: '{{ routes.all_products_collection_url }}',
        collections_url: '{{ routes.collections_url }}',
        product_recommendations_url: '{{ routes.product_recommendations_url }}',
      };
    </script>
  </head>

  <body>
    <a class="skip-to-content-link" href="#MainContent">
      {{ 'accessibility.skip_to_text' | t }}
    </a>

    {% section 'header' %}

    <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>

    {% section 'footer' %}

    {%- comment -%} Load JavaScript bundles efficiently {%- endcomment -%}

    {%- comment -%} Core functionality - load first {%- endcomment -%}
    <script src="{{ 'core.bundle.js' | asset_url }}" defer="defer"></script>

    {%- comment -%} Feature bundles - load on demand {%- endcomment -%}
    <script>
      // Prevent duplicate script loading
      window.loadedScripts = new Set();

      // Load feature bundles based on page type
      document.addEventListener('DOMContentLoaded', function() {
        const pageType = '{{ request.page_type }}';

        // Load features bundle for all pages
        loadScript('{{ 'features.bundle.js' | asset_url }}');

        // Load UI bundle for all pages
        loadScript('{{ 'ui.bundle.js' | asset_url }}');

        // Load helpers bundle for all pages
        loadScript('{{ 'helpers.bundle.js' | asset_url }}');

        // Load system bundle for all pages
        loadScript('{{ 'system.bundle.js' | asset_url }}');

        // Page-specific bundles
        if (pageType === 'product') {
          loadScript('{{ 'feature-product.js' | asset_url }}');
          loadScript('{{ 'feature-gallery.js' | asset_url }}');
        }

        if (pageType === 'collection') {
          loadScript('{{ 'feature-collection.js' | asset_url }}');
          loadScript('{{ 'quick-add.js' | asset_url }}');
        }

        if (pageType === 'search') {
          loadScript('{{ 'feature-search.js' | asset_url }}');
        }
      });

      function loadScript(src) {
        // Prevent duplicate loading
        if (window.loadedScripts.has(src)) {
          return;
        }

        const script = document.createElement('script');
        script.src = src;
        script.defer = true;

        // Mark as loaded before appending to prevent race conditions
        window.loadedScripts.add(src);

        document.head.appendChild(script);
      }
    </script>

    {%- comment -%} Performance monitoring {%- endcomment -%}
    <script>
      // Core Web Vitals monitoring
      if ('PerformanceObserver' in window) {
        // LCP (Largest Contentful Paint)
        new PerformanceObserver((list) => {
          const entries = list.getEntries();
          const lastEntry = entries[entries.length - 1];
          console.log('LCP:', lastEntry.startTime);

          // Report to analytics if needed
          if (window.gtag) {
            gtag('event', 'LCP', {
              value: Math.round(lastEntry.startTime),
              event_category: 'Web Vitals',
            });
          }
        }).observe({ entryTypes: ['largest-contentful-paint'] });

        // FID (First Input Delay)
        new PerformanceObserver((list) => {
          const entries = list.getEntries();
          entries.forEach((entry) => {
            console.log('FID:', entry.processingStart - entry.startTime);

            if (window.gtag) {
              gtag('event', 'FID', {
                value: Math.round(entry.processingStart - entry.startTime),
                event_category: 'Web Vitals',
              });
            }
          });
        }).observe({ entryTypes: ['first-input'] });

        // CLS (Cumulative Layout Shift) - with fallback for unsupported browsers
        let clsValue = 0;
        try {
          new PerformanceObserver((list) => {
            const entries = list.getEntries();
            entries.forEach((entry) => {
              if (!entry.hadRecentInput) {
                clsValue += entry.value;
                console.log('CLS:', clsValue);

                if (window.gtag) {
                  gtag('event', 'CLS', {
                    value: Math.round(clsValue * 1000) / 1000,
                    event_category: 'Web Vitals',
                  });
                }
              }
            });
          }).observe({ entryTypes: ['layout-shift'] });
        } catch (error) {
          // Silently handle unsupported entry types
          console.debug('Layout shift monitoring not supported in this browser');
        }
      }
    </script>

    {%- comment -%} Service Worker Registration {%- endcomment -%}
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('{{ 'system-service-worker.js' | asset_url }}')
            .then(function(registration) {
              console.log('Service Worker registered successfully:', registration.scope);
            })
            .catch(function(error) {
              console.log('Service Worker registration failed:', error);
            });
        });
      }
    </script>

    {%- comment -%} Theme editor support {%- endcomment -%}
    {%- if request.design_mode -%}
      <script src="{{ 'system-theme-editor.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}
  </body>
</html>
