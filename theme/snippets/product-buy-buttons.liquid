{% comment %}
  Renders product buy buttons with proper form handling and accessibility

  Accepts:
  - block: {Object} Block settings (required)
  - product: {Object} Product Liquid object (required)
  - product_form_id: {String} Form ID for the product form (required)
  - section_id: {String} Section ID (required)

  Usage:
  {% render 'product-buy-buttons', block: block, product: product, product_form_id: 'product-form-123', section_id: section.id %}
{% endcomment %}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign show_dynamic_checkout = block.settings.show_dynamic_checkout | default: true
-%}

<div class="product-form__buttons space-y-4">
  <product-form class="product-form" data-hide-errors="{{ product.selected_or_first_available_variant.available }}">
    <div class="product-form__error-message-wrapper" role="alert" hidden>
      <svg
        aria-hidden="true"
        focusable="false"
        class="icon icon-error"
        viewBox="0 0 13 13"
      >
        <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
        <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
        <path d="m5.87413 3.52832 5.6689 0.112701 0.11662 5.66816-5.66989-0.112701z" fill="white"/>
        <path d="m4.10322 5.2041 7.32986 0.139267 0.13926 7.32986-7.32986-0.139267z" fill="white"/>
      </svg>
      <span class="product-form__error-message"></span>
    </div>

    {%- form 'product',
      product,
      id: product_form_id,
      class: 'form',
      novalidate: 'novalidate',
      data-type: 'add-to-cart-form'
    -%}
      <input type="hidden" name="id" value="{{ current_variant.id }}" class="product-variant-id">

      <div class="product-form__buttons space-y-3">
        <button
          type="submit"
          name="add"
          class="add-to-cart-btn product-form__cart-submit relative"
          {% if current_variant.available == false %}
            disabled
          {% endif %}
        >
          <!-- Button Content -->
          <div class="flex items-center justify-center gap-3 px-6 py-3">
            <!-- Cart Icon -->
            <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 01-2 2H9a2 2 0 01-2-2v-6m8 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01"/>
            </svg>

            <!-- Button Text -->
            <span class="font-semibold text-black text-base">
              {%- if current_variant.available -%}
                {{ 'products.product.add_to_cart' | t }}
              {%- else -%}
                {{ 'products.product.sold_out' | t }}
              {%- endif -%}
            </span>
          </div>

          <!-- Loading Spinner -->
          <div class="loading-overlay__spinner hidden absolute inset-0 flex items-center justify-center">
            <div class="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
          </div>
        </button>

        {%- if show_dynamic_checkout -%}
          {{ form | payment_button }}
        {%- endif -%}
      </div>
    {%- endform -%}
  </product-form>
</div>

<script>
  if (!customElements.get('product-form')) {
    customElements.define(
      'product-form',
      class ProductForm extends HTMLElement {
        constructor() {
          super();

          this.form = this.querySelector('form');
          this.form.querySelector('[name=id]').disabled = false;
          this.form.addEventListener('submit', this.onSubmitHandler.bind(this));
          this.cart = document.querySelector('cart-notification') || document.querySelector('cart-drawer');
          this.submitButton = this.querySelector('[type="submit"]');
          this.submitButtonText = this.submitButton.querySelector('span');

          if (document.querySelector('cart-drawer')) this.submitButton.setAttribute('aria-haspopup', 'dialog');

          this.hideErrors = this.dataset.hideErrors === 'true';
        }

        onSubmitHandler(evt) {
          evt.preventDefault();
          if (this.submitButton.getAttribute('aria-disabled') === 'true') return;

          this.handleErrorMessage();

          this.submitButton.setAttribute('aria-disabled', true);
          this.submitButton.classList.add('loading');
          this.querySelector('.loading-overlay__spinner').classList.remove('hidden');

          const config = {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              Accept: 'application/json',
            },
          };

          const formData = new FormData(this.form);
          if (this.cart) {
            formData.append(
              'sections',
              this.cart.getSectionsToRender().map((section) => section.id)
            );
            formData.append('sections_url', window.location.pathname);
          }
          config.body = formData;

          fetch(`${window.routes.cart_add_url}`, config)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              const contentType = response.headers.get('content-type');
              if (contentType && contentType.includes('application/json')) {
                return response.json();
              } else {
                // Handle HTML response (redirect)
                window.location = window.routes.cart_url;
                return null;
              }
            })
            .then((response) => {
              // If response is null, we're redirecting
              if (response === null) {
                return;
              }

              if (response.status) {
                publish(PUB_SUB_EVENTS.cartError, {
                  source: 'product-form',
                  productVariantId: formData.get('id'),
                  errors: response.errors || response.description,
                  message: response.message,
                });
                this.handleErrorMessage(response.description);

                const soldOutMessage = this.submitButton.querySelector('.sold-out-message');
                if (!soldOutMessage) return;
                this.submitButton.setAttribute('aria-disabled', false);
                this.submitButton.classList.remove('loading');
                this.querySelector('.loading-overlay__spinner').classList.add('hidden');
                return;
              } else if (!this.cart) {
                window.location = window.routes.cart_url;
                return;
              }

              if (!this.error)
                publish(PUB_SUB_EVENTS.cartUpdate, {
                  source: 'product-form',
                  productVariantId: formData.get('id'),
                  cartData: response,
                });
              this.handleErrorMessage();
              this.submitButton.setAttribute('aria-disabled', false);
              this.submitButton.classList.remove('loading');
              this.querySelector('.loading-overlay__spinner').classList.add('hidden');
            })
            .catch((e) => {
              console.error('Add to cart error:', e);
              this.handleErrorMessage('Failed to add item to cart. Please try again.');
              this.submitButton.setAttribute('aria-disabled', false);
              this.submitButton.classList.remove('loading');
              this.querySelector('.loading-overlay__spinner').classList.add('hidden');
            })
            .finally(() => {
              this.submitButton.classList.remove('loading');
              if (this.cart && this.cart.classList.contains('is-empty')) this.cart.classList.remove('is-empty');
              if (!this.error) this.submitButton.removeAttribute('aria-disabled');
              this.querySelector('.loading-overlay__spinner').classList.add('hidden');
            });
        }

        handleErrorMessage(errorMessage = false) {
          if (this.hideErrors) return;

          this.errorMessageWrapper =
            this.errorMessageWrapper || this.querySelector('.product-form__error-message-wrapper');
          if (!this.errorMessageWrapper) return;
          this.errorMessage =
            this.errorMessage || this.errorMessageWrapper.querySelector('.product-form__error-message');

          this.errorMessageWrapper.toggleAttribute('hidden', !errorMessage);

          if (errorMessage) {
            this.errorMessage.textContent = errorMessage;
          }
        }
      }
    );
  }
</script>

<style>
  .add-to-cart-btn {
    border: none;
    border-radius: 6px;
    font-weight: 600;
    transition: background-color 0.2s ease, transform 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: fit-content;
  }

  .add-to-cart-btn:hover {
    transform: translateY(-1px);
  }

  .add-to-cart-btn:active {
    transform: translateY(0);
  }

  .add-to-cart-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .add-to-cart-btn.loading {
    color: transparent;
  }

  .add-to-cart-btn.loading .loading-overlay__spinner {
    display: flex !important;
  }

  .add-to-cart-btn .loading-overlay__spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .add-to-cart-btn {
      padding: 0.5rem 0.75rem;
    }
  }

  @media (max-width: 480px) {
    .add-to-cart-btn {
      padding: 0.375rem 0.625rem;
      font-size: 0.8rem;
    }
  }
</style>
